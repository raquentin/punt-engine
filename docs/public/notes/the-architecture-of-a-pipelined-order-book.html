<!DOCTYPE html>
<html lang="en"><head><title>The architecture of a pipelined order book</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM Mono&amp;family=DM Serif Display:wght@400;700&amp;family=Inter:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="The architecture of a pipelined order book"/><meta property="og:description" content="This page explains the design of a pipelined order book called Pipebomb. Pipebomb Is a Pipelined and Eventually Balanced Order-Managing Book. In short, the hardware module takes in a stream from Nasdaq’s ITCH protocol and maintains calculations of metrics that drive strategic decisions."/><meta property="og:image" content="https://punt-engine.com/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="This page explains the design of a pipelined order book called Pipebomb. Pipebomb Is a Pipelined and Eventually Balanced Order-Managing Book. In short, the hardware module takes in a stream from Nasdaq’s ITCH protocol and maintains calculations of metrics that drive strategic decisions."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="notes/the-architecture-of-a-pipelined-order-book"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="..">Punt Engine</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="recent-notes desktop-only"><h3>Recent Notes</h3><ul class="recent-ul"><li class="recent-li"><div class="section"><div class="desc"><h3><a href="../notes/the-architecture-of-a-pipelined-order-book" class="internal">The architecture of a pipelined order book</a></h3></div><p class="meta">Mar 06, 2025</p><ul class="tags"></ul></div></li><li class="recent-li"><div class="section"><div class="desc"><h3><a href="../notes/the-intuition-behind-moving-avg-accumulator" class="internal">Building a moving average accumulator core</a></h3></div><p class="meta">Feb 24, 2025</p><ul class="tags"></ul></div></li></ul><p><a href="../notes/">See 3 more →</a></p></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../notes/">Notes</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>The architecture of a pipelined order book</a></div></nav><h1 class="article-title">The architecture of a pipelined order book</h1><p show-comma="true" class="content-meta"><span>Mar 06, 2025</span><span>12 min read</span></p></div></div><article class="popover-hint"><p>This page explains the design of a pipelined order book called Pipebomb. Pipebomb Is a Pipelined and Eventually Balanced Order-Managing Book. In short, the hardware module takes in a stream from Nasdaq’s ITCH protocol and maintains calculations of metrics that drive strategic decisions. These metrics are accumulated in discrete and configurable circuits that read from caches for internal order book data structures (see <a href="#caching-common-indicator-parameters" class="internal alias">Caching</a>). The following sections break down Pipebomb into it’s data structures, algorithms, and pipeline stages. Find more information in the Discord or <a href="https://github.com/raquentin/punt-engine/tree/main/pipebomb" class="external">the source<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<h2 id="io">I/O<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#io" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Let’s talk concretely about the input and output of this entire circuit, first by comparing Pipebomb to a normal CPU.</p>
<p>The data models are entirely different. Where traditional von Neumann architectures are fetching instructions from memory, loading them into L1i, and jumping a PC throughout a process, Pipebomb’s instructions are a bit more transitive. The ITCH stream comes in on a wire, and we read this wire to perform the operation (something like ADD_ORDER, EXEC_ORDER, DEL_ORDER). Once the ITCH message’s operation has been performed, it’s useless.</p>
<p>Another key difference is that Pipebomb is not Turing-complete. Traditional processors provide an effectively Turing-complete ISA which can perform any computation given time and resources. Write your program, compile it for your architecture, and run it. The whole appeal of using the FPGA platform is that we aren’t bound by this. For a quick example, imagine compiling some pattern-matching logic with 100 patterns to assembly. Ignoring the jump table optimization for a minute, your assembly will have hundreds of instructions comparing the value to each branch and jumping to the relevant label if it is. This will take many clock cycles. In contrast, on an FPGA we could just synthesize this logic with a multiplexer. It’s a function of combinational logic and will take a fraction of a single clock cycle.</p>
<h3 id="itch-messages-as-cpu-instructions">ITCH messages as CPU instructions<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#itch-messages-as-cpu-instructions" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>So without some traditional ISA, what do we have? We have a stream of ITCH messages that we interpret as CPU instructions. They look something like this:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">typedef enum logic [</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">3</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] {</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_ADD              </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_OEXEC            </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h2</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_PEXEC            </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h3</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_CANCEL           </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h4</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_DELETE           </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h5</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  ITCH_REPLACE          </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4'h6</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">} opcode_t;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">typedef enum logic {</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  SIDE_BID </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  SIDE_ASK </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b1</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">} side_t;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">typedef struct packed {</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  opcode_t          opcode;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic             valid;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">63</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]      timestamp;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  side_t            side;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [ORDER_ID_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] order_id;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [PRICE_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]    price;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [QUANTITY_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] quantity;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [ORDER_ID_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] new_order_id; </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">// replace only</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">} inst_t;</span></span></code></pre></figure>
<p>Instead of opcodes like <code>add</code> or <code>lw</code>, we have those from the ITCH protocol description.</p>
<h3 id="accumulators">Accumulators<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#accumulators" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Accumulators are the outputs. The whole point of writing an order book here is to quickly find market indicators that drive strategic decisions. These indiators are things like <a href="../notes/moving-average-accumulator" class="internal alias" data-slug="notes/moving-average-accumulator">moving average</a>, volatility, and mid-price.</p>
<h3 id="state">State<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#state" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Between this input stream and these accumulators is a lot of state:</p>
<ul>
<li>The depth of each price in the market. The market is split up into two arrays mapping price levels to quantities, one for bids and one for asks.</li>
<li>An index of previous orders. The <code>ITCH_ADD</code> instruction supplies an orderID, a price, and a quantity. The <code>ITCH_DELETE</code> instruction only supplies and orderID. We need to save the price and quantity associated with each orderID so when the order’s state changes at Nasdaq we can update our underlying data structures accordingly despite not immediately knowing what price level the order was.</li>
<li>Caches. Some architectural decisions mean that some order book traversal algorithms have poor time complexities. We fix this by caching things relevant to them.</li>
<li>Messages. We queue messages in a FIFO to ensure we don’t double count nor lose any instructions.</li>
</ul>
<h2 id="pipelining">Pipelining<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#pipelining" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><img src="../images/pipelined-ob.png" width="auto" height="auto" alt/></p>
<p>Here’s the order book broken down into its modules and their dependencies. For a quick summary, orders come in, are decoded into into <code>inst_t</code>, and placed in a queue. Every cycle, we dequeue an instruction (perhaps multiple later on). If this instruction is not an <code>ITCH_ADD</code>, that implies the order it’s updating already exists, so we need to fetch information about it from the <a href="#router-and-order-map" class="internal alias">Order Map</a>. With all info in hand, we split off into <a href="#bid-and-ask-processors" class="internal alias">the Bid side and the Ask side</a>. Now we’re parallelized on two axes, performing order book update operations on disjoint data structures. Then we have the <a href="#accumulators" class="internal alias">accumulators</a>, which maintain the inputs to strategic decisions as described above.</p>
<h3 id="message-decoder-and-fifo">Message decoder and FIFO<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#message-decoder-and-fifo" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>As mentioned, the “instructions” in our architecture are not compiled binaries that carry out some process loaded into memory. They are a stream of ITCH messages. This stream is raw bytes on a wire, we’ll need to parse them into a sort of instruction.</p>
<p>The implementation of this parser is <a href="https://github.com/mbattyani/sub-25-ns-nasdaq-itch-fpga-parser" class="external">complex<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. Punt Engine’s design is not yet defined. Regardless, messages will be parsed into an <code>inst_t</code> and enqueued into the Message FIFO. From there the rest of the pipeline will dequeue instructions and execute them.</p>
<p>With this setup, we won’t execute the same instruction twice as it’s dequeued and deleted after is passed through the pipeline.</p>
<p>There are a few techniques to not miss instructions, which involves overflowing of the FIFO:</p>
<ul>
<li>send backpressure signal to exchange</li>
<li>lower in the network stack, drop irrelevant ethernet frames or other structures</li>
<li>have multiple entire pipelines processing orders. We are working to find parallelism on this axis.</li>
</ul>
<h3 id="router-and-order-map">Router and order map<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#router-and-order-map" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>At this point, we have a single <code>inst_t</code> and we’re ready to begin updating our order book. Recall what <code>inst_t</code> looks like:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">typedef struct packed {</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  opcode_t          opcode;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic             valid;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">63</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]      timestamp;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  side_t            side;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [ORDER_ID_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] order_id;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [PRICE_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]    price;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [QUANTITY_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] quantity;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  logic [ORDER_ID_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">] new_order_id; </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">// replace only</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">} inst_t;</span></span></code></pre></figure>
<p>Know that no instruction uses each of these signals itself. The structure is essentially a union of all the data that any one instruction needs. We wrap them into <code>inst_t</code> and then split the bus carrying the instruction to get the data we actually want.</p>
<p>Here’s a quick breakdown of <code>inst_t</code>:</p>
<ul>
<li><code>opcode</code> is the type of ITCH message (ADD/EXEC/DELETE).</li>
<li><code>valid</code> marks whether the message contains meaningful data and facilitates bubbling and error handling.</li>
<li><code>timestamp</code> is the timestamp of the request. Perhaps it can be useful for synchronization if we parallelize the design later.</li>
<li><code>side</code> is either bid or ask. We’ll route the instruction to the relevant side processor based on this.</li>
<li><code>price</code> is a price. Note that we can perform some type of bucketing with the price to decrease the perceived book sparsity. If it doesn’t impact our strategy too much, dividing <code>price</code> by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.04</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span></span></span></span>0.08 will use less energy, less surface area, and increase book density. Many of the design decisions in later stages are particularly efficient for dense books. Dense books have relatively small gaps between populated price levels. It’s a bit beyond the scope of this post, but previous designs considered using a self-balancing tree backing structure to be more efficient for sparse books<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label" class="internal alias">1</a></sup>. That’s where the “Eventually Balanced” in the Pipebomb acronym comes from.</li>
<li><code>quantity</code> is the additional depth to be added at the relevant price level by this order. In the case of CANCEL or DELETE instructions, this quantity will be negative and pulled from the Order Map, see below.</li>
<li><code>new_order_id</code> is only for REPLACE instructions.</li>
</ul>
<p>The goal of this part of the order book is to take instructions and update the order books state based on them. As hinted at earlier, the effect of DELTE and CANCEL operations is not explicit from the ITCH messages they’re parsed from. You can imagine that deleting an order involves removing the depth that it added to its price level in the order book. We’d do this by decrementing the depth there by the amount that was initially added. The problem is that the DELETE instruction only specifies the <code>order_id</code> to be deleted, it doesn’t include the price or quantity to be decremented. For that reason we have an Order Map, a mapping of <code>order_id</code>s to <code>price</code>s and <code>quantity</code>s. This pipeline stage fetches data from this map when necessary and prepares it for the next stage, which actually acts out the message’s effect on the book.</p>
<h3 id="bid-and-ask-processors">Bid and ask processors<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#bid-and-ask-processors" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>The bid and the ask processor are degeneralizations of the side processor, another stage in this pipeline. Each processor is a manager for two underlying data structures.</p>
<p>The first is a circular buffer. It’s an array with a predefinized length, let’s call that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>. Ignoring bucketing for a second, imagine we’re trading BTC. Then <code>buffer[$100,000.01]</code> = the total volume across all orders at the same price level as <code>$100,000.01</code> in this side of the book. If we’re counting from $0.00 though, this array is going to be huge. Say we offset it a bit, starting at $90,000.00, so <code>buffer[$100,000.01 - $90,000.00]</code> = the total volume across all orders at the same price level as <code>$100,000.01</code>. With this we save space, but certainly if BTC increases to $1m, we can’t accomodate. So the final design involves taking the price index mod <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> and getting that index of the buffer. Here <code>buffer[$100,000.01 mod 10.24]</code> is the total volume. Obviously, if we index $100,010.25, we will get the same quantity as we did for $100,000.01. Making this space optimization assumes that the strategy that we’re working with only really cares about the inside of the book. Good order book implementations are driven by good strategies, finding a strategy that is profitable for a small <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> will improve this part of the pipeline.</p>
<p>The second is a <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>-best price levels cache. Recall the tradeoff between the circular buffer design and the self-balancing tree design mentioned above. The circular buffer has <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> random access time, but is very space inefficient for sparse books. With sparse books our backing array will be full of zeroes, with only a small percentage of indices actually populated with orders. The self-balancing tree avoids this by only managing nodes for price levels that are populated, with <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">))</span></span></span></span> random access time. Another skip-list like optimization on top of that makes certain accumulator calculations faster. Each side of the book maintains the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> best bids or asks for use in calculating accumulators.</p>
<h3 id="caching-common-indicator-parameters">Caching common indicator parameters<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#caching-common-indicator-parameters" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Let’s talk more on this <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>-best cache. A problem with the circular buffer design is that updating the best <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> bids or <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> asks takes linear time. You need to move from the middle of the book towards the poles until you find <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> populated price levels. Doing this on every clock cycle would make this the slowest stage in the pipeline, decreasing the global clock speed. Instead, we can just cache the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> levels.</p>
<p>Let’s look at some Verilog:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">module</span><span style="--shiki-light:#FFCB6B;--shiki-dark:#2E8F82;"> price_cache</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> #(</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  parameter</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> CACHE_LEVELS </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 5</span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // k</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">)(</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // ... interface signals ...</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // Input from side processor</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  input</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">  logic [PRICE_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">]  update_price,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  input</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">  logic [QUANTITY_BITS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">] update_quantity,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  input</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">  logic                   update_valid,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  input</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">  logic                   is_bid_side</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // Output to metrics calculator</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  output</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> price_level_t           cached_levels[CACHE_LEVELS],</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  output</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> logic                   cache_valid</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">);</span></span></code></pre></figure>
<p>Each side processor has a <code>price_cache</code> between it and the metrics calculator. This cache is sorted.</p>
<p>Also note that the side processor can update the best price in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> time like this:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">PROCESS_ADD: </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    price_levels[process_idx].total_quantity </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> price_levels[process_idx].total_quantity </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> process_quantity;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    price_levels[process_idx].valid </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    if</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> (is_better_than_current_best(process_idx)) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">      update_best_needed </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    end</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  end</span></span></code></pre></figure>
<p>But it’s for <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> where we have to traverse down the price levels.</p>
<p>Now within the cache, there’s two main operations:</p>
<ul>
<li>Single-level updating. If the <code>update_price</code> from the side processor is already in the cache, we just update it by <code>update_quantity</code>. If <code>update_quantity</code> is 0 though, we need to remove it. We’d shift all the entries in the cache up in the buffer, then clear the last entry. If the <code>update_price</code> is not in the cache, we add this new level in, shifting all current cache entries down.</li>
<li>Cache rebalancing. Recall how the side processors are backed by circular buffers. When the best price crosses some multiple of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>, the indices of the buffer now have a new meaning, and the indices in the cache are useless. We’d need to rebuild the entire cache.</li>
</ul>
<h3 id="accumulators-1">Accumulators<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#accumulators-1" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Accumulators are the thing that all other levels have worked to produce. We’ve defined them above, let’s just see what they look like.</p>
<p>You can calculate the mid-price based on the bid and ask caches:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">always_comb </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  if</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> (bid_cached_levels[</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">].valid </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&amp;&amp;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> ask_cached_levels[</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">].valid) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    mid_price </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> (bid_cached_levels[</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">].price </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> ask_cached_levels[</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">].price) </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">>></span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    mid_price_valid </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  end</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> else</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> begin</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    mid_price </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> last_mid_price;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    mid_price_valid </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1'b0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  end</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">end</span></span></code></pre></figure>
<p>You can calculate exponential moving averages similarly:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">always_ff @(</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">posedge</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> clk) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  if</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> (update_metrics </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&amp;&amp;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> mid_price_valid) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">    // EMA = α * price + (1-α) * previous_EMA</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    ema_short_reg </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(mid_price, ALPHA_SHORT) </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(ema_short_reg, ONE </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> ALPHA_SHORT);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    ema_medium_reg </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(mid_price, ALPHA_MEDIUM) </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(ema_medium_reg, ONE </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> ALPHA_MEDIUM);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    ema_long_reg </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(mid_price, ALPHA_LONG) </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> fixed_multiply(ema_long_reg, ONE </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> ALPHA_LONG);</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  end</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">end</span></span></code></pre></figure>
<p>You can imagine how other accumulators use the caches or even communicate directly with the side processors to grab inputs and maintain some market indicator.</p>
<h2 id="all-together">All together<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#all-together" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>We’ve defined the I/O of this circuit, its pipeline stages, and the data structures and algorithms that make everything possible. Along with all of these pipeline stage modules, we’d have a top module that wraps all of them and provides an interface to the order book. We’d connect this to an ITCH parserthat itself handles the OSI stack and stream connection. We’d likely output to some DMA controller that would use AMD IP and Madlib to communicate across PCIe to a host OS.</p>
<p>Look again at the order book broken down into its modules. Do you understand it? If not, send a message in Discord or come to office hours.</p>
<p><img src="../images/pipelined-ob.png" width="auto" height="auto" alt/></p>
<section data-footnotes class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#footnote-label" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ol>
<li id="user-content-fn-1">
<p>This prior design was inspired by <a href="https://www.doc.ic.ac.uk/~wl/papers/17/fpl17ch.pdf" class="external">Exploring the Potential of Reconfigurable Platforms for Order Book Update<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. <a href="#user-content-fnref-1" data-footnote-backref aria-label="Back to reference 1" class="data-footnote-backref internal alias">↩</a></p>
</li>
</ol>
</section></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" id="toc" class aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content" class><ul class="overflow"><li class="depth-0"><a href="#io" data-for="io">I/O</a></li><li class="depth-1"><a href="#itch-messages-as-cpu-instructions" data-for="itch-messages-as-cpu-instructions">ITCH messages as CPU instructions</a></li><li class="depth-1"><a href="#accumulators" data-for="accumulators">Accumulators</a></li><li class="depth-1"><a href="#state" data-for="state">State</a></li><li class="depth-0"><a href="#pipelining" data-for="pipelining">Pipelining</a></li><li class="depth-1"><a href="#message-decoder-and-fifo" data-for="message-decoder-and-fifo">Message decoder and FIFO</a></li><li class="depth-1"><a href="#router-and-order-map" data-for="router-and-order-map">Router and order map</a></li><li class="depth-1"><a href="#bid-and-ask-processors" data-for="bid-and-ask-processors">Bid and ask processors</a></li><li class="depth-1"><a href="#caching-common-indicator-parameters" data-for="caching-common-indicator-parameters">Caching common indicator parameters</a></li><li class="depth-1"><a href="#accumulators-1" data-for="accumulators-1">Accumulators</a></li><li class="depth-0"><a href="#all-together" data-for="all-together">All together</a></li></ul></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li>No backlinks found</li></ul></div></div><footer class><p>📉 An FPGA-accelerated high-frequency trading engine.</p><ul><li><a href="https://github.com/raquentin/punt-engine">GitHub</a></li><li><a href="https://discord.gg/2A2dpwfxBF">Discord</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">
        const socket = new WebSocket('ws://localhost:3001')
        // reload(true) ensures resources like images and scripts are fetched again in firefox
        socket.addEventListener('message', () => document.location.reload(true))
      </script><script src="../postscript.js" type="module"></script></html>
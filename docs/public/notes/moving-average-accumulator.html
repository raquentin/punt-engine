<!DOCTYPE html>
<html lang="en"><head><title>Building a moving average accumulator core</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM Mono&amp;family=DM Serif Display:wght@400;700&amp;family=Inter:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="Building a moving average accumulator core"/><meta property="og:description" content="This post guides readers from a blank folder to a working and tested moving average accumulator gateware circuit. I’ll first describe the intuition for the algorithm, then implement it in SystemVerilog, then write a Verilator testbench in C++."/><meta property="og:image" content="https://punt-engine.com/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="This post guides readers from a blank folder to a working and tested moving average accumulator gateware circuit. I’ll first describe the intuition for the algorithm, then implement it in SystemVerilog, then write a Verilator testbench in C++."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="notes/moving-average-accumulator"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="..">Punt Engine</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="recent-notes desktop-only"><h3>Recent Notes</h3><ul class="recent-ul"><li class="recent-li"><div class="section"><div class="desc"><h3><a href="../notes/the-architecture-of-a-pipelined-order-book" class="internal">The architecture of a pipelined order book</a></h3></div><p class="meta">Mar 06, 2025</p><ul class="tags"></ul></div></li><li class="recent-li"><div class="section"><div class="desc"><h3><a href="../notes/the-intuition-behind-moving-avg-accumulator" class="internal">Building a moving average accumulator core</a></h3></div><p class="meta">Feb 24, 2025</p><ul class="tags"></ul></div></li></ul><p><a href="../notes/">See 3 more →</a></p></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../notes/">Notes</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Building a moving average accumulator core</a></div></nav><h1 class="article-title">Building a moving average accumulator core</h1><p show-comma="true" class="content-meta"><span>Feb 24, 2025</span><span>11 min read</span></p></div></div><article class="popover-hint"><p>This post guides readers from a blank folder to a working and tested moving average accumulator gateware circuit. I’ll first describe the intuition for the algorithm, then implement it in SystemVerilog, then write a Verilator testbench in C++.</p>
<p>Exactly what we’re building is a clocked circuit that takes in a price and returns the average price over the last <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> samples. We’ll parameterize <code>k</code> and the bit width of the price, namely <code>n</code>, using the SystemVerilog <code>parameter</code> keyword.</p>
<h2 id="setup">Setup<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#setup" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This post is a coding exercise. Create a new folder with nothing in it.</p>
<p>You’ll need these dependencies:</p>
<ul>
<li>Verilator</li>
<li>A C++ compiler</li>
<li>CMake</li>
</ul>
<p>Our project uses Nix for this. You’re recommended to use our <a href="https://github.com/raquentin/punt-engine/blob/main/flake.nix" class="external"> Nix Flake developer environment<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to get the exact versions our project builds with. You can delete all the Haskell/Clash stuff, we’re just working with Verilog today. Otherwise just download the deps yourself.</p>
<p>Create these files:</p>
<ul>
<li><code>Makefile</code>: We’ll use CMake to control more complex Verilator and <code>make</code> commands.</li>
<li><code>mov_avg_acc.sv</code>: This is the moving average accumulator. We’ll implement it in SystemVerilog.</li>
<li><code>testbench.cpp</code>: We compare the output of a software testbench to that of our accumulator core to ensure it workstestbench.cpp`:</li>
</ul>
<p>Now you’re setup. Let’s begin.</p>
<h2 id="intuition">Intuition<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#intuition" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Consider the simplest interface to an accumulator circuit. Like any clocked circuit, we’ll have an <code>input wire clk</code>. Likewise, we’ll have an <code>input wire reset</code>.</p>
<p>That’s the foundation, but what is the real i/o for this circuit? We take in a stream of prices. What we’re calling a price is a value represented by a bus of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> wires. These wires together allow the representation of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7477em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> values. In our case, these values are prices. We’ll have an <code>input wire unsigned d_in</code>, which holds the price that we are to sample on the next rising clock edge. We don’t want to lock users of this circuit to only a certain <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> value; our core should be agnostic to the bit depth of the price of the asset that it is accumulating. So we’ll abstract away this <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> using a parameter called <code>DataWidth</code>.</p>
<p>With these inputs, we perform some logic, and produce an output. This output is going to a price, so it will be the same type as the <code>d_in</code> wire.</p>
<p>Here’s what that looks like in <code>mov_avg_acc.sv</code>:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="v" data-theme="material-theme-darker vitesse-light"><code data-language="v" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#1E754F;">module</span><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;"> mov_avg_acc</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> #</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">(</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    parameter integer Exponent  </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">/*verilator public*/</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">  =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 3</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    parameter integer DataWidth  </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">/*verilator public*/</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 16</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    input wire clk</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    input wire reset</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    input wire unsigned </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">]</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> d_in</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    output reg unsigned </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">]</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> d_out</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">;</span></span></code></pre></figure>
<p>Let’s break down this syntax a bit:</p>
<ul>
<li><code>module mov_avg_acc</code> defines a reusable hardware component called mov_avg_acc. Other modules can embed this module, linking their wires to the inputs and outputs of our core.</li>
<li>Next is a list bound by <code>#(...)</code>. This is the parameter list, here go constants like Exponent (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>) and DataWidth (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>). When synthesizing our mov_avg_acc core, we can pass these parameters in without having to go in and change the internal RTL of our circuit.</li>
<li>Finally is this list bound by <code>(...)</code>. Within this list are all i/o. In our case, we have the three inputs and one output described above.</li>
</ul>
<h3 id="circular-buffers">Circular buffers<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#circular-buffers" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Let’s ignore the interface described above and generalize the moving average problem a bit. We have a stream of prices over time, and want to maintain the average over the last <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> of them. Naively, computing an average involves summing up all samples in a set and dividing that sum by the size of the set.</p>
<p>Consider an implementation of the circuit that maintains an stack-like array structure of infinite size. On each clock edge, we push the current price (the value of <code>d_in</code>) on top of this stack. Then we sum up the top <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> elements on the stack, divide that sum by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, and put that result into the register <code>d_out</code>.</p>
<p>The problem with this is that we don’t infinite memory. So instead of an infinitely large stack, we’ll maintain an array of size <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, and a pointer to the oldest index in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, called <code>oldest_index</code>. Since we’re only concerned with the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> most recent samples, on a given clock edge, the price in the array at <code>oldest_index</code> was <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> samples ago and hence does not impact the value we push to <code>d_out</code>. So on this new edge, we can just overwrite <code>array[oldest_index]</code> with <code>d_in</code>, fixing the infinite memory problem.</p>
<p>So now, we have an array in our circuit with the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> most recent samples. On each cycle, we could sum up the array in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> time, then divide by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> and be done. That’s a bit naive though, we can sum the array in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> time by realizing that on a given cycle, we increase the sum by <code>d_in</code> and decrease it by <code>array[oldest_index]</code>, AKA the price <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> samples ago. So instead of summing up the whole array, we just subtract by the oldest sample and add the newest one: <code>d_in</code>. Then we divide by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>.</p>
<h3 id="an-optimization-for-k--2n">An optimization for <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>.<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#an-optimization-for-k--2n" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>There’s one last optimization. Imagine that in the circuit above <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> is 10; we’re calculating the average over the last 10 samples. Dividing by 10 on computers is slow and difficult. We either use a floating point unit and deal with fractions of the price, or use fast division algorithms. Look up hardware division algorithms if you care to learn more, but the point here is that they are slow and we want to avoid them when possible.</p>
<p>When <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span> (for some <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span>, not the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> from before related to bit depth), we can use the right shift operation to divide the sum by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> in less than one clock cycle. Instead of performing some series of operations to implement a general division algorithm, we essentially just ignore the least significant <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> bits of the sum.</p>
<h2 id="implementation">Implementation<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#implementation" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>You’ve learned the algorithm. Let’s implement it. There’s a few things to note first before we get into the full code:</p>
<h3 id="the-bit-width-of-the-sum-of-array--n">The bit width of the sum of <code>array</code> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-bit-width-of-the-sum-of-array--n" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Recall that the <code>array</code> consists of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> elements of size <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> (<code>[DataWidth-1:0]</code>). In the calculation of <code>d_out</code>, we can’t simply store this sum in an <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>-bit wire because we will have overflow. To prevent overflow, our temporary <code>sum</code> wire must be of size <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>. So in our circuit we have:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="v" data-theme="material-theme-darker vitesse-light"><code data-language="v" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">reg unsigned </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">AccWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">]</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> acc;</span></span></code></pre></figure>
<p>Note that this is not a <code>reg</code> in the circuit’s i/o list; it’s a local/intermediate <code>reg</code>.</p>
<h3 id="localparam"><code>localparam</code><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#localparam" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>For convenience, we have:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="v" data-theme="material-theme-darker vitesse-light"><code data-language="v" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">localparam integer </span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">N</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> Exponent;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">localparam integer </span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">AccWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> DataWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> Exponent;</span></span></code></pre></figure>
<p><code>N</code> defines the aforementioned <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> but uppercase to match formatting standards. <code>AccWidth</code> is the bit depth of the <code>acc</code> reg, which is the numerator in the average calculation, AKA the sum of the elements of <code>array</code>. It’s of depth <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>.</p>
<p>The <code>localparam</code> keybord is a bit like C’s <code>#define</code>. We setup these aliases to avoid pasting those rvalues all over the place.</p>
<h3 id="for-loops-in-hardware-description-languages"><code>for</code> loops in hardware description languages<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#for-loops-in-hardware-description-languages" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>In the code below, you’ll see a loop that instantiates the elements of the <code>array</code> of sample history, here named <code>sample_buffer</code>:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="v" data-theme="material-theme-darker vitesse-light"><code data-language="v" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">for</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">i</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">; i </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> N; i</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">++</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> begin</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">    sample_buffer</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">i</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">]</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;"> '0;</span></span>
<span data-line><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">end</span></span></code></pre></figure>
<p>Remember that we’re describing hardware, not writing software. <code>for</code> here is not the imperative <code>for</code> loop that it is in software. Here, it essentially is a compile-time <code>for</code> that expands into an assignment of each element of the sample buffer to <code>0</code> without having to copy-paste that assignment for each hardcoded <code>i</code> upto <code>N</code>. This loop does NOT perform some type of iterative operation at runtime.</p>
<h3 id="sign-extension">Sign extension<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#sign-extension" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Recall the operation where we subtract out the oldest sample and add in the newest. Here’s the code for that:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> acc</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> -</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> {</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">     {(AccWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> DataWidth){sample_buffer[oldest_index][DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]}},</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">     sample_buffer[oldest_index]</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">   }</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> +</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> {{(AccWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> DataWidth){d_in[DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">]}}, d_in};</span></span></code></pre></figure>
<p>In short, we’re setting <code>acc &lt;= acc - subtrahend + addend</code>.</p>
<p>In the subtrahend, <code>{(AccWidth - DataWidth){sample_buffer[oldest_index][DataWidth-1]}}</code> performs a sign-extension. That’s a bit confusing though since all these values are unsigned. It’s really just a pattern to extend <code>sample_buffer[oldest_index]</code> to the size of the larger <code>acc</code> to allow them to be subtracted. It takes the most significant bit of the oldest sample and replicated it upto the size of <code>acc</code>, then concatenates that with the oldest sample itself.</p>
<p>Similarly, <code>{{(AccWidth - DataWidth){d_in[DataWidth-1]}}, d_in}</code> expands <code>d_in</code> to the width of <code>acc</code>.</p>
<h2 id="the-entire-systemverilog-core">The entire SystemVerilog core<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-entire-systemverilog-core" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>With the intuition and notes out of the way, we’ve almost accidentally built the whole circuit. It’s pasted below with comments inline.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="verilog" data-theme="material-theme-darker vitesse-light"><code data-language="verilog" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">module</span><span style="--shiki-light:#FFCB6B;--shiki-dark:#2E8F82;"> moving_average_accumulator</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> #(</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">    // we use Exponent to enforce that k = 2^n</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    parameter</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> Exponent  </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">/*verilator public*/</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">  =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 3</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    parameter</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> DataWidth  </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">/*verilator public*/</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 16</span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"> // n</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">) (</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    input</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> wire</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> clk,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    input</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> wire</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> reset,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    input</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> wire</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> unsigned</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> [DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">] d_in,</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    output</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> reg</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> unsigned</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> [DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">] d_out</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  localparam</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> K </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> Exponent;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  localparam</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> AccWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> DataWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> Exponent;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // holds sum of last `N` samples</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  reg</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> unsigned</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> [AccWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">] acc;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // circular buffer storing last k samples</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  reg</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> unsigned</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> [DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">] sample_buffer[K];</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // index of oldest element in `sample_buffer`</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> oldest_index;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // loop</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  integer</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> i;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">  always_ff @(</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">posedge</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> clk </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">or</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> posedge</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> reset) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    if</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> (reset) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      acc   </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> '</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      d_out </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> '</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // reset sample buffer</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">      for</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> (i </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">; i </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> K; i</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">++</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">) </span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">begin</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        sample_buffer[i] </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> '</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">      end</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">;</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    end</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> else</span><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;"> begin</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // subtract oldest, add newest</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> acc</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">       -</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> {</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">           {(AccWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> DataWidth){sample_buffer[oldest_index][DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">]}},</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">           sample_buffer[oldest_index]</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">         }</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">       +</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> {{(AccWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> DataWidth){d_in[DataWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">]}}, d_in};</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // overwrite oldest sample</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      sample_buffer[oldest_index] </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> d_in;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // inc oldest_index. wrap around using modulo K</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> (oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">) </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">%</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> K;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // compute moving average by dividing by 2^exponent</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">      d_out </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> acc[AccWidth</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">1</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">:Exponent];  </span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">// like a right shift</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">    end</span></span>
<span data-line><span style="--shiki-light:#F78C6C;--shiki-dark:#1E754F;">  end</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">endmodule</span></span></code></pre></figure>
<h2 id="testbench">Testbench<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#testbench" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>We have the gateware core completed; now let’s test it. If we can assume some knowledge of C++, I can just explain the testbench in comments:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="material-theme-darker vitesse-light"><code data-language="cpp" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">// verilator compiles our mov_avg_acc.sv to cpp, that's the file below</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">Vmoving_average_accumulator.h</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">// we'll instantiate it in our function, run some inputs through it, and compare</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">verilated.h</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">verilated_vcd_c.h</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &lt;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">cstdlib</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">></span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &lt;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">iostream</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">></span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">include</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &lt;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">vector</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">></span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#999999;--shiki-dark-font-style:inherit;">#</span><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">define</span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;"> SIM_TIME</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 20</span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"> // Simulation time in clock cycles</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">int</span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;"> main</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">(</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">int</span><span style="--shiki-light:#EEFFFF;--shiki-light-font-style:italic;--shiki-dark:#B07D48;--shiki-dark-font-style:inherit;"> argc</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;"> char</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;"> **</span><span style="--shiki-light:#EEFFFF;--shiki-light-font-style:italic;--shiki-dark:#B07D48;--shiki-dark-font-style:inherit;">argv</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> {</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // setup</span></span>
<span data-line><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;">  Verilated</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">commandArgs</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">argc</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> argv</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">);</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // top is a C++ version of the SystemVerilog core we wrote</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  Vmoving_average_accumulator </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">*</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">top </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> new</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> Vmoving_average_accumulator</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">  VerilatedVcdC </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">*</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">tfp </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#89DDFF;--shiki-dark:#1E754F;"> nullptr</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#FFCB6B;--shiki-dark:#998418;">  vluint64_t</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> sim_time </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // these are the input wires we had in out circuit.</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // we're setting them up</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // reset->1 sets up the sample_buffer</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">  top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">clk</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">  top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">reset</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">  top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">d_in</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // what we're really doing from here down is setting up the &quot;expected&quot; values</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // that we'll compare to the output of our verilog circuit.</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // to get these expected values, we need to rewrite our circuit's logic in C++</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // same constants from sv</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  const</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;"> int</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> Exponent </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 3</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  const</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;"> int</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> N </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> Exponent</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  const</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;"> int</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> DataWidth </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 16</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // our C++ version doesn't naturally respond to the clock</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // and hence doesn't have a delay in its output</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // we store the values like this to mock this delay</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  uint16_t</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> one_ago </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  uint16_t</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> two_ago </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  uint16_t</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> expected_out </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;">  std</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">vector</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;</span><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">uint16_t</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">></span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;"> sample_buffer</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">N</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">,</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">);</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  uint32_t</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"> // using 32 bits to prevent overflow</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // current index pointing to the oldest sample</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">  int</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // simulation loop</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">  while</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">sim_time </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> SIM_TIME</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> {</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">    // invert clock</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">    top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">clk</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> !</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">clk</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">    // allow time for reset</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">    if</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">sim_time </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">></span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 4</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">      top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">reset</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 0</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">    // the real logic for the rising edge of the clock</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">    if</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">clk</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> {</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // pseudorandom input price</span></span>
<span data-line><span style="--shiki-light:#C792EA;--shiki-dark:#AB5959;">      uint16_t</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> input_data </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;">3</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> *</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> sim_time </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 2</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> %</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 8031</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">      top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">d_in</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> input_data</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"> // assert d_in with that price</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">      // remake the logic in C++</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">      if</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">!</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">reset</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> {</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">-=</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;"> sample_buffer</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">oldest_index</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">];</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> input_data</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">        sample_buffer</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">[</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">oldest_index</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">]</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> input_data</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">oldest_index </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">+</span><span style="--shiki-light:#F78C6C;--shiki-dark:#2F798A;"> 1</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> %</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> N</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">        // mock the delay</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        two_ago </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> one_ago</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        one_ago </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> expected_out</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">        expected_out </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> acc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">>></span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> Exponent</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">        // compare and err if bad</span></span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">        // if the sim ends without error, we passed</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">        if</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> (</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">d_out</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> !=</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> two_ago</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> {</span></span>
<span data-line><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;">          std</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">cerr </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;&lt;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">Mismatch on simtime</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> sim_time </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;&lt;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">: expected </span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">                    &lt;&lt;</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> two_ago </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;&lt;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">, got </span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;"> top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">d_out</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;"> std</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">endl</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">          return</span><span style="--shiki-light:#F07178;--shiki-dark:#393A34;"> EXIT_FAILURE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">        }</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">      }</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">    top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">eval</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">();</span></span>
<span data-line> </span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#F07178;--shiki-dark:#393A34;">    sim_time</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">++</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">  }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">  top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">-></span><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">final</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">();</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // cleanup</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">  delete</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> top</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;">  // test passed</span></span>
<span data-line><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;">  std</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">cout </span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;">&lt;&lt;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;"> &quot;</span><span style="--shiki-light:#C3E88D;--shiki-dark:#B56959;">Simulation completed successfully.</span><span style="--shiki-light:#89DDFF;--shiki-dark:#B5695977;">&quot;</span><span style="--shiki-light:#89DDFF;--shiki-dark:#AB5959;"> &lt;&lt;</span><span style="--shiki-light:#FFCB6B;--shiki-dark:#59873A;"> std</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">::</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">endl</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-light-font-style:italic;--shiki-dark:#1E754F;--shiki-dark-font-style:inherit;">  return</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> EXIT_SUCCESS</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">;</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">}</span></span></code></pre></figure>
<h2 id="makefile">Makefile<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#makefile" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>In order to run this locally and in CI, we’ll use this <code>Makefile</code>:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="make" data-theme="material-theme-darker vitesse-light"><code data-language="make" data-theme="material-theme-darker vitesse-light" style="display:grid;"><span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Top-level module name</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">TOP_MODULE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> moving_average_accumulator</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Verilog source files</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">VERILOG_SOURCES</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> $(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TOP_MODULE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">.sv</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># C++ testbench file</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">TESTBENCH</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> tb.cpp</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Output directory</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">OBJ_DIR</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> obj_dir</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Simulation executable</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#B07D48;">SIM_EXE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> =</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> $(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">OBJ_DIR</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">/V</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TOP_MODULE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Default target</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#998418;">.PHONY</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> all</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">all</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> run_simulation</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Compile Verilog and C++ sources</span></span>
<span data-line><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">SIM_EXE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">: </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">VERILOG_SOURCES</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> $(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TESTBENCH</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">	verilator --cc </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">VERILOG_SOURCES</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> --exe </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TESTBENCH</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> --trace</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">	make -j -C </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">OBJ_DIR</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> -f V</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TOP_MODULE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">.mk V</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">TOP_MODULE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Run the simulation</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#998418;">.PHONY</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> run_simulation</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">run_simulation</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;"> $(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">SIM_EXE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">	./</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">SIM_EXE</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Clean up generated files</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#998418;">.PHONY</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> clean</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">clean</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span></span>
<span data-line><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;">	rm -rf </span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">$(</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#B56959;">OBJ_DIR</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">)</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> waveform.vcd</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#545454;--shiki-light-font-style:italic;--shiki-dark:#A0ADA0;--shiki-dark-font-style:inherit;"># Phony target for CI testing (exits with non-zero status on failure)</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#998418;">.PHONY</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> test</span></span>
<span data-line><span style="--shiki-light:#82AAFF;--shiki-dark:#59873A;">test</span><span style="--shiki-light:#89DDFF;--shiki-dark:#999999;">:</span><span style="--shiki-light:#EEFFFF;--shiki-dark:#393A34;"> run_simulation</span></span></code></pre></figure>
<h2 id="running-it">Running it<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#running-it" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>That’s all the code. Let’s run it. If you have the dependecies setup, run <code>make test</code>.</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" id="toc" class aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content" class><ul class="overflow"><li class="depth-0"><a href="#setup" data-for="setup">Setup</a></li><li class="depth-0"><a href="#intuition" data-for="intuition">Intuition</a></li><li class="depth-1"><a href="#circular-buffers" data-for="circular-buffers">Circular buffers</a></li><li class="depth-1"><a href="#an-optimization-for-k--2n" data-for="an-optimization-for-k--2n">An optimization for k = 2^n.</a></li><li class="depth-0"><a href="#implementation" data-for="implementation">Implementation</a></li><li class="depth-1"><a href="#the-bit-width-of-the-sum-of-array--n" data-for="the-bit-width-of-the-sum-of-array--n">The bit width of the sum of array != n</a></li><li class="depth-1"><a href="#localparam" data-for="localparam">localparam</a></li><li class="depth-1"><a href="#for-loops-in-hardware-description-languages" data-for="for-loops-in-hardware-description-languages">for loops in hardware description languages</a></li><li class="depth-1"><a href="#sign-extension" data-for="sign-extension">Sign extension</a></li><li class="depth-0"><a href="#the-entire-systemverilog-core" data-for="the-entire-systemverilog-core">The entire SystemVerilog core</a></li><li class="depth-0"><a href="#testbench" data-for="testbench">Testbench</a></li><li class="depth-0"><a href="#makefile" data-for="makefile">Makefile</a></li><li class="depth-0"><a href="#running-it" data-for="running-it">Running it</a></li></ul></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="../notes/the-architecture-of-a-pipelined-order-book" class="internal">The architecture of a pipelined order book</a></li></ul></div></div><footer class><p>📉 An FPGA-accelerated high-frequency trading engine.</p><ul><li><a href="https://github.com/raquentin/punt-engine">GitHub</a></li><li><a href="https://discord.gg/2A2dpwfxBF">Discord</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">
        const socket = new WebSocket('ws://localhost:3001')
        // reload(true) ensures resources like images and scripts are fetched again in firefox
        socket.addEventListener('message', () => document.location.reload(true))
      </script><script src="../postscript.js" type="module"></script></html>